# PostgreSQL Client Authentication Configuration File
# ===================================================
#
# This configuration file controls PostgreSQL client authentication.
# For the Community Activity Tracker deployment, we use peer authentication
# exclusively to eliminate password-based authentication vulnerabilities.
#
# Requirements: 3.1, 3.4
#
# SECURITY MODEL:
# - Peer authentication: Maps OS usernames to database usernames via Unix domain sockets
# - No password authentication: All password-based methods are explicitly rejected
# - No network connections: All TCP/IP connections are rejected
#
# AUTHENTICATION FLOW:
# 1. Backend API container runs as OS user 'apiuser' (UID 1001)
# 2. Connection is made via Unix domain socket (/var/run/postgresql/.s.PGSQL.5432)
# 3. PostgreSQL verifies the OS user making the connection
# 4. If OS username matches database username, authentication succeeds
# 5. No passwords are required or accepted
#
# FILE FORMAT:
# TYPE  DATABASE        USER            ADDRESS                 METHOD
#
# TYPE: Connection type (local = Unix socket, host = TCP/IP)
# DATABASE: Database name or 'all' for all databases
# USER: Database username or 'all' for all users
# ADDRESS: Client IP address or hostname (only for 'host' type)
# METHOD: Authentication method (peer, md5, reject, etc.)

# ============================================================================
# UNIX DOMAIN SOCKET CONNECTIONS (peer authentication)
# ============================================================================
#
# Allow all local connections via Unix domain socket using peer authentication.
# This is the ONLY authentication method that will succeed.
#
# Peer authentication works by:
# - Obtaining the OS username of the client process from the operating system
# - Checking if a database user with the same name exists
# - Granting access if the names match (no password required)
#
# Example: If the backend API container runs as OS user 'apiuser' and connects
# via Unix socket, PostgreSQL will authenticate it as database user 'apiuser'.

local   all             all                                     peer

# ============================================================================
# TCP/IP CONNECTIONS (explicitly rejected)
# ============================================================================
#
# Reject ALL TCP/IP connections (both IPv4 and IPv6).
# This prevents any network-based authentication attempts, including:
# - Password-based authentication (md5, scram-sha-256)
# - Trust authentication
# - Certificate-based authentication
#
# Security rationale:
# - Eliminates password storage and transmission vulnerabilities
# - Prevents network-based attacks on the database
# - Enforces Unix socket communication only
# - Ensures peer authentication is the only authentication method

# Reject all IPv4 TCP/IP connections
host    all             all             0.0.0.0/0               reject

# Reject all IPv6 TCP/IP connections
host    all             all             ::/0                    reject

# ============================================================================
# NOTES
# ============================================================================
#
# 1. Order matters: PostgreSQL uses the first matching rule
# 2. The 'local' rule must come before 'host' rules
# 3. The 'reject' method explicitly denies connections (more secure than omitting rules)
# 4. This configuration is copied to /etc/postgresql/ in the database container
# 5. Changes to this file require container restart to take effect
#
# TESTING PEER AUTHENTICATION:
# - Success case: Backend container connects as 'apiuser' via Unix socket
# - Failure case: Any connection attempt with password will be rejected
# - Failure case: Any TCP/IP connection attempt will be rejected
#
# TROUBLESHOOTING:
# - If connections fail, verify OS user matches database user
# - Check that Unix socket is accessible (permissions on /var/run/postgresql)
# - Verify socket volume is properly mounted in both containers
# - Check PostgreSQL logs for authentication errors
